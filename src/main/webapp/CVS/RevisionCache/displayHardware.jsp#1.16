<%-- 
    Document   : displayHardware
    Created on : Jan 15, 2013, 12:36:21 PM
    Author     : focke
--%>

<%@page contentType="text/html" pageEncoding="US-ASCII"%>
<%@taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@taglib prefix="sql" uri="http://java.sun.com/jsp/jstl/sql" %>
<%@taglib prefix="display" uri="http://displaytag.sf.net" %>
<%@taglib prefix="traveler" tagdir="/WEB-INF/tags"%>
<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
        <title>Hardware</title>
    </head>
    <body>
        <h1>Hardware!</h1>
        <sql:query var="hardwareTypeQ" dataSource="jdbc/rd-lsst-cam">
            select HT.id, HT.name, H.lsstId from Hardware H, HardwareType HT where 
            H.id=?<sql:param value="${param.hardwareId}"/>
            and 
            HT.id=H.typeId;
        </sql:query>
        <c:set var="hardwareType" value="${hardwareTypeQ.rows[0]}"/>
        <table>
            <tr><td>Id:</td><td>${hardwareType.lsstId}</td></tr>
            <tr><td>Type:</td><td>${hardwareType.name}</td></tr>
        </table>
        
        <h2>Nicknames</h2>
        <sql:query var="identifiersQ" dataSource="jdbc/rd-lsst-cam">
            select HI.identifier, HIA.name
            from HardwareIdentifier HI, HardwareIdentifierAuthority HIA
            where HI.hardwareId=?<sql:param value="${param.hardwareId}"/>
            and HIA.id=HI.authorityId;
        </sql:query>
        <display:table name="${identifiersQ.rows}" class="datatable">
            <display:column property="identifier"/>
            <display:column property="name" title="IdAuth"/>
        </display:table>
            
        <sql:query var="idAuthQ" dataSource="jdbc/rd-lsst-cam">
           select * from HardwareIdentifierAuthority 
           where
           id not in (select HIA.id from 
                HardwareIdentifierAuthority HIA, HardwareIdentifier HI
                where
                HI.hardwareId=?<sql:param value="${param.hardwareId}"/>
                and
                HIA.id=HI.authorityId);
        </sql:query>
        <c:if test="${not empty idAuthQ.rows}">
            <form METHOD=GET ACTION="addIdentifier.jsp">
                <input type="hidden" name="hardwareId" value="${param.hardwareId}">
                <input type="hidden" name="hardwareTypeId" value="${hardwareType.id}">

                Identifier: <INPUT TYPE=TEXT NAME=identifier SIZE=20>

                Identifier Authority: <select name="authId">
                <c:forEach var="iaRow" items="${idAuthQ.rows}">
                    <option value="${iaRow.id}" <c:if test="${! empty sessionScope.siteName and sessionScope.siteName==iaRow.name}">selected</c:if>>${iaRow.name}</option>
                </c:forEach>
                </select>

                <INPUT TYPE=SUBMIT value="Add Nickname">
            </form>
        </c:if>
        
        <h2>Travelers</h2>
        <sql:query var="travelersQ" dataSource="jdbc/rd-lsst-cam">
            select A.*, P.name from Activity A, Process P
            where
            P.id=A.processId
            and
            A.hardwareId=?<sql:param value="${param.hardwareId}"/>
            and
            A.processEdgeId is null;
        </sql:query>
        <display:table name="${travelersQ.rows}" class="datatable">
            <display:column property="name" title="Name" sortable="true" headerClass="sortable"
                            href="displayActivity.jsp" paramId="activityId" paramProperty="id"/>
            <display:column property="begin" sortable="true" headerClass="sortable"/>
            <display:column property="createdBy" sortable="true" headerClass="sortable"/>
            <display:column property="end" sortable="true" headerClass="sortable"/>
            <display:column property="closedBy" sortable="true" headerClass="sortable"/>
        </display:table>
        
        <sql:query var="applicableTTypesQ" dataSource="jdbc/rd-lsst-cam">
            select * from Process P
            where 
            P.id not in (select distinct child from ProcessEdge)
            and
            P.hardwareTypeId=?<sql:param value="${hardwareType.id}"/>;
        </sql:query>
        <form method=GET action="createTraveler.jsp">
            <input type="hidden" name="hardwareId" value="${param.hardwareId}">
            <input type="hidden" name="inNCR" value="FALSE">
            Traveler Type: <select name="processId">
                <c:forEach var="pRow" items="${applicableTTypesQ.rows}">
                    <option value="${pRow.id}">${pRow.name}</option>
                </c:forEach>
                <input type="SUBMIT" value="Apply Traveler">
            </select>
        </form>
                
                
        <h2>Components</h2>
<%--
        <sql:query var="components" dataSource="jdbc/rd-lsst-cam">
            select HR.componentId, HR.begin, HR.end, HRT.name as relationshipName, HT.name as hardwareName
            from HardwareRelationship HR, HardwareRelationshipType HRT, HardwareType HT, Hardware H
            where 
            HR.hardwareId=? 
            and 
            HR.hardwareRelationshipTypeId=HRT.id
            and 
            HT.id=H.TypeId
            and 
            H.id=HR.componentId
            and 
            HR.end is null
             <sql:param value="${param['hardwareId']}"/>
        </sql:query>
        <display:table name="${components.rows}" class="datatable">
            <display:column property="componentId" sortable="true" headerClass="sortable"
                            href="displayHardware.jsp" paramId="hardwareId" paramProperty="componentId"/>
            <display:column property="hardwareName" title="Type"/>
            <display:column property="begin" sortable="true" headerClass="sortable"/>
            <display:column property="end" sortable="true" headerClass="sortable"/>
            <display:column property="relationshipName"/>
        </display:table>
--%>
        <traveler:componentTable hardwareId="${param.hardwareId}"/>
        
        <h2>Component of</h2>
<%--
        <sql:query var="componentOf" dataSource="jdbc/rd-lsst-cam">
            select HR.hardwareId, HR.begin, HR.end, HRT.name as relationshipName, HT.name as hardwareName
            from HardwareRelationship HR, HardwareRelationshipType HRT, HardwareType HT, Hardware H
            where 
            HR.componentId=? 
            and 
            HR.hardwareRelationshipTypeId=HRT.id
            and 
            HT.id=H.TypeId
            and 
            H.id=HR.hardwareId
            and 
            HR.end is null
             <sql:param value="${param['hardwareId']}"/>
        </sql:query>
        <display:table name="${componentOf.rows}" class="datatable">
            <display:column property="hardwareId" sortable="true" headerClass="sortable"
                            href="displayHardware.jsp" paramId="hardwareId" paramProperty="hardwareId"/>
            <display:column property="hardwareName" title="Type"/>
            <display:column property="begin" sortable="true" headerClass="sortable"/>
            <display:column property="end" sortable="true" headerClass="sortable"/>
            <display:column property="relationshipName"/>
        </display:table>
--%>
         <traveler:compOfTable hardwareId="${param.hardwareId}"/>
    </body>
</html>

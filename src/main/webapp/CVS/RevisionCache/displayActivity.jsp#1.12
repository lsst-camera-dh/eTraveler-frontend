<%-- 
    Document   : displayActivity
    Created on : Jan 29, 2013, 5:09:56 PM
    Author     : focke
--%>

<%@page contentType="text/html" pageEncoding="US-ASCII"%>
<%@taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@taglib prefix="sql" uri="http://java.sun.com/jsp/jstl/sql" %>
<%@taglib prefix="display" uri="http://displaytag.sf.net" %>
<%@taglib prefix="traveler" tagdir="/WEB-INF/tags"%>
<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
        <title>Activity</title>
    </head>
    <body>
        <traveler:setPaths activityId="${param['activityId']}"/>
        <h1>Activity
            <c:out value="${activityPath}"/>
            <traveler:activityCrumbs activityPath="${activityPath}"/>
        </h1>
        <h2>Process
            <c:out value="${processPath}"/>
            <traveler:processCrumbs processPath="${processPath}"/>
        </h2>
        <sql:query var="activity" dataSource="jdbc/rd-lsst-cam">
            select * from Activity where id=?
            <sql:param value="${param['activityId']}"/>
        </sql:query>
        <sql:query var="hardware" dataSource="jdbc/rd-lsst-cam">
            select * from Hardware where id=?
            <sql:param value="${activity.rows[0]['hardwareId']}"/>
        </sql:query>
        <sql:query var="process" dataSource="jdbc/rd-lsst-cam">
            select * from Process where id=?
            <sql:param value="${activity.rows[0]['processId']}"/>
        </sql:query>
        <display:table name="${hardware.rows}" class="datatable"/>
        <display:table name="${process.rows}" class="datatable"/>
        <display:table name="${activity.rows}" class="datatable"/>
<%--            
        <sql:query var="finishedChildren" dataSource="jdbc/rd-lsst-cam">
            select A.id, A.begin, A.end, P.name, PE.step
            from Activity A, Process P, ProcessEdge PE
            where 
            A.hardwareId=?
            AND 
            A.processId=PE.child and PE.parent=?
            and
            A.processEdgeId=PE.id
            AND
            A.processId=P.id
            and 
            A.end is not null
            order by step
            <sql:param value="${activity.rows[0]['hardwareId']}"/>
            <sql:param value="${activity.rows[0]['processId']}"/>
        </sql:query>
--%>
        <sql:query var="finishedChildren" dataSource="jdbc/rd-lsst-cam">
            select A.id, A.begin, A.end, P.name, PE.step
            from Activity A, Process P, ProcessEdge PE
            where 
            A.parentActivityId=?
            and
            P.id=A.processId
            and
            PE.id=A.processEdgeId
            and 
            A.end is not null
            order by step
            <sql:param value="${param['activityId']}"/>
        </sql:query>
            
<%--            
        <sql:query var="unFinishedChildren" dataSource="jdbc/rd-lsst-cam">
            select A.id, A.begin, P.name, PE.step
            from Activity A, Process P, ProcessEdge PE
            where 
            A.hardwareId=?
            AND
            A.processId=PE.child
            and
            PE.parent=?
            and
            A.processEdgeId=PE.id
            AND
            A.processId=P.id
            and 
            A.end is null
            order by step
            <sql:param value="${activity.rows[0]['hardwareId']}"/>
            <sql:param value="${activity.rows[0]['processId']}"/>
        </sql:query>
--%>
        <sql:query var="unFinishedChildren" dataSource="jdbc/rd-lsst-cam">
            select A.id, A.begin, P.name, PE.step
            from Activity A, Process P, ProcessEdge PE
            where 
            A.parentActivityId=?
            and
            P.id=A.processId
            and
            PE.id=A.processEdgeId
            and 
            A.end is null
            order by step
            <sql:param value="${param['activityId']}"/>
        </sql:query>
<%--
        <sql:query var="unStartedChildren" dataSource="jdbc/rd-lsst-cam">
            select P.id, P.name, P.hardwareRelationshipTypeId, PE.id as processEdgeId, PE.step
            from Process P, ProcessEdge PE
            where
            P.id not in (select A.processId from Activity A, ProcessEdge PE where 
                            A.hardwareId=?
                            AND
                            A.processId=PE.child
                            and
                            PE.parent=?
                            and
                            A.processEdgeId=PE.id)
            and
            PE.parent=?
            and
            P.id=PE.child
            order by step
            <sql:param value="${activity.rows[0]['hardwareId']}"/>
            <sql:param value="${activity.rows[0]['processId']}"/>
            <sql:param value="${activity.rows[0]['processId']}"/>
        </sql:query>    
--%>
        <sql:query var="unStartedChildren" dataSource="jdbc/rd-lsst-cam">
            select P.id, P.name, P.hardwareRelationshipTypeId, PE.id as processEdgeId, PE.step
            from Process P, ProcessEdge PE
            where
            PE.parent=?
            and
            P.id=PE.child
            and
            PE.id not in (select processEdgeId from Activity where parentActivityId=?)
            order by step
            <sql:param value="${activity.rows[0]['processId']}"/>
            <sql:param value="${param['activityId']}"/>
        </sql:query>    
            
        <c:if test="${empty activity.rows[0]['end'] and empty unFinishedChildren.rows and empty unStartedChildren.rows}">
            <form METHOD=GET ACTION="closeoutActivity.jsp">
                <input type="hidden" name="activityId" value="${param['activityId']}">       
                <INPUT TYPE=SUBMIT value="Closeout">
            </form>
        </c:if>
            

        <table border=""1">
            <tr> <th>Link</th> <th>Name</th> <th>Step</th> <th>Begin</th> <th>End</th> </tr>
            
            <c:forEach var="row" items="${finishedChildren.rows}">
                <tr>
                    <td><a href="displayActivity.jsp?activityId=${row.id}">Activity ${row.id}</a></td>
                    <td>${row.name}</td> <td>${row.step}</td> <td>${row.begin}</td> <td>${row.end}</td>
                </tr>
            </c:forEach>
                
            <c:forEach var="row" items="${unFinishedChildren.rows}">
                <tr>
                    <td><a href="displayActivity.jsp?activityId=${row.id}">Activity ${row.id}</a></td>
                    <td>${row.name}</td> <td>${row.step}</td> <td>${row.begin}</td> 
                    <td>
                        <c:choose>
                            <c:when test="0">
                                <form METHOD=GET ACTION="closeoutActivity.jsp">
                                    <input type="hidden" name="activityId" value="${row.id}">       
                                    <INPUT TYPE=SUBMIT value="Closeout">
                                </form>
                            </c:when>
                            <c:otherwise>
                                <a href="displayActivity.jsp?activityId=${row.id}">Needs work</a>
                            </c:otherwise>
                        </c:choose>
                    </td>
                </tr>
            </c:forEach>
                
            <c:forEach var="row" items="${unStartedChildren.rows}" varStatus="status">
                <tr>
                    <td><a href="dumpProcess.jsp?processPath=${processPath}.${row.id}">Process ${row.id}</a></td>
                    <td>${row.name}</td> <td>${row.step}</td> 
                    <td>
                        <c:if test="${status.first && empty unFinishedChildren.rows}">
                            <form METHOD=GET ACTION="createChildActivity.jsp">
                                <input type="hidden" name="hardwareId" value="${activity.rows[0]['hardwareId']}">       
                                <input type="hidden" name="inNCR" value="${activity.rows[0]['inNCR']}">       
                                <input type="hidden" name="processId" value="${row.id}">       
                                <input type="hidden" name="processEdgeId" value="${row.processEdgeid}">
                                <input type="hidden" name="parentActivityId" value="${param['activityId']}">

                                <c:if test="${! empty row.hardwareRelationshipTypeId}">
                                    <sql:query var="potentialComponents" dataSource="jdbc/rd-lsst-cam">
                                        select H.id, HT.name 
                                        from Hardware H, HardwareType HT, HardwareRelationshipType HRT, Activity A
                                        where 
                                        HRT.id=?
                                        and
                                        HT.id=HRT.componentTypeId
                                        and
                                        H.TypeId=HRT.componentTypeId
                                        and 
                                        H.id=A.hardwareId and A.end is not null and A.parentActivityId is null
                                        and
                                        H.id not in (select componentId from HardwareRelationship where end is null)
                                        <sql:param value="${row.hardwareRelationshipTypeId}"/>
                                    </sql:query>
                
                                    <select name="componentId">
                                        <c:forEach var="row" items="${potentialComponents.rows}" varStatus="status">
                                        <option value="${row.id}">${row.id}</option>
                                        </c:forEach>
                                    </select>
                                </c:if>            
            
                                <INPUT TYPE=SUBMIT value="Initiate">
                            </form>    
                        </c:if>
                    </td> 
                    <td></td>
                </tr>
            </c:forEach>
            
        </table>

    </body>
</html>
